generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [postgis]
}

model User {
  id            String         @id @default(uuid())
  cinNumber     String?        @unique @map("cin_number")
  cinHash       String?        @unique @map("cin_hash")
  phoneNumber   String         @unique @map("phone_number")
  phoneHash     String         @unique @map("phone_hash")
  phoneVerified Boolean        @default(false) @map("phone_verified")
  email         String?        @unique
  password      String?
  otpCode       String?        @map("otp_code")
  otpExpiresAt  DateTime?      @map("otp_expires_at")
  otpAttempts   Int            @default(0) @map("otp_attempts")
  fullName      String?        @map("full_name")
  role          Role           @default(CITIZEN)
  isActive      Boolean        @default(true) @map("is_active")
  points        Int            @default(0)
  createdAt     DateTime       @default(now()) @map("created_at")
  lastLogin     DateTime?      @map("last_login")
  reportUpdates ReportUpdate[]
  upvotes       ReportUpvote[]
  reports       Report[]

  @@index([cinHash])
  @@map("users")
}

model Report {
  id                  String         @id @default(uuid())
  userId              String         @map("user_id")
  category            Category
  subcategory         String?
  description         String?
  locationLat         Float          @map("location_lat")
  locationLng         Float          @map("location_lng")
  address             String?
  communeId           String?        @map("commune_id")
  provinceId          String?        @map("province_id")
  regionId            String?        @map("region_id")
  status              ReportStatus   @default(NEW)
  priority            Int            @default(2)
  aiConfidence        Float?         @map("ai_confidence")
  aiSuggestedCategory String?        @map("ai_suggested_category")
  photoUrls           String[]       @map("photo_urls")
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")
  resolvedAt          DateTime?      @map("resolved_at")
  assignedToId        String?        @map("assigned_to_id")
  department          String?
  upvoteCount         Int            @default(0) @map("upvote_count")
  isDuplicate         Boolean        @default(false) @map("is_duplicate")
  duplicateOfId       String?        @map("duplicate_of_id")
  updates             ReportUpdate[]
  upvotes             ReportUpvote[]
  duplicateOf         Report?        @relation("Duplicates", fields: [duplicateOfId], references: [id])
  duplicates          Report[]       @relation("Duplicates")
  user                User           @relation(fields: [userId], references: [id])

  @@index([status])
  @@index([createdAt])
  @@index([locationLat, locationLng])
  @@map("reports")
}

model ReportUpdate {
  id          String        @id @default(uuid())
  reportId    String        @map("report_id")
  updatedById String        @map("updated_by_id")
  oldStatus   ReportStatus? @map("old_status")
  newStatus   ReportStatus? @map("new_status")
  comment     String?
  photoUrls   String[]      @map("photo_urls")
  createdAt   DateTime      @default(now()) @map("created_at")
  report      Report        @relation(fields: [reportId], references: [id], onDelete: Cascade)
  updatedBy   User          @relation(fields: [updatedById], references: [id])

  @@map("report_updates")
}

model ReportUpvote {
  reportId  String   @map("report_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  report    Report   @relation(fields: [reportId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([reportId, userId])
  @@map("report_upvotes")
}

model SmsReport {
  id                String   @id @default(uuid())
  phoneNumber       String   @map("phone_number")
  smsBody           String   @map("sms_body")
  parsedCategory    String?  @map("parsed_category")
  parsedDescription String?  @map("parsed_description")
  parsedLocation    String?  @map("parsed_location")
  reportId          String?  @map("report_id")
  status            String   @default("pending")
  createdAt         DateTime @default(now()) @map("created_at")

  @@map("sms_reports")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum Role {
  CITIZEN
  FIELD_WORKER
  ADMIN
  SUPER_ADMIN
}

enum Category {
  ROAD
  LIGHTING
  WASTE
  WATER
  SANITATION
  PUBLIC_SPACE
  SIGNAGE
  OTHER
}

enum ReportStatus {
  NEW
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  CLOSED
  REJECTED
  DUPLICATE
}
